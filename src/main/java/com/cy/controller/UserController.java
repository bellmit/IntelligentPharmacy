package com.cy.controller;import com.cy.bean.*;import com.cy.biz.PhamacyService;import com.cy.biz.UserService;import com.cy.biz.bizImp.UserServiceImpl;import com.cy.util.StringUtils;import com.github.pagehelper.PageInfo;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.ui.Model;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.bind.annotation.ResponseBody;import sun.misc.BASE64Decoder;import javax.imageio.ImageIO;import javax.servlet.ServletException;import javax.servlet.ServletOutputStream;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import javax.servlet.http.HttpSession;import java.awt.image.BufferedImage;import java.io.IOException;import java.sql.SQLException;import java.util.ArrayList;import java.util.HashMap;import java.util.HashSet;import java.util.Map;@Controller@RequestMapping("/userPage")public class UserController {    private Map<String,Object> map = new HashMap<>();    HttpSession session;    @Autowired    private PhamacyService phamacyService;    @Autowired    private UserService userServiceImpl ;    Map<String,Object>addUserMap =new HashMap<String,Object>();    Map<String,Object>checkName =new HashMap<String,Object>();    //前台药品展示    @RequestMapping("/selectPhamacyDrugs.action")    public String selectPhamacyReceive(HttpServletRequest request, String num , String state,String drugName){        if(!StringUtils.isEmpty(state)){            map.put("state",state);        }if(!StringUtils.isEmpty(drugName)){            map.put("drugName",drugName);        }        PageInfo<PhamacyDrug> phamacyDrugPageInfo = phamacyService.selectPhamacyAllDrugsPageInfo(map, num, 10);        if (phamacyDrugPageInfo!=null) {            map.clear();            HttpSession session = request.getSession();            request.setAttribute("phamacyReceive",phamacyDrugPageInfo);            return "/userPage/pharacyDrugs";        } else {            return "error";        }    }    //报损id查询报损信息    @RequestMapping("/selectPhamacyDrugDetils.action")    public  String selectPhamacyDrugReceiveDetils(HttpServletRequest request, String receiverId ){                if(!StringUtils.isEmpty(receiverId)){            int a = Integer.parseInt(receiverId);            PhamacyDrug phamacyDrug  = phamacyService.selectByIdPhamacyDrug(a);            request.setAttribute("phamacyDrug",phamacyDrug);        }        return "userPage/pharacyDrugsDetils";    }    @RequestMapping(value="/images.action",method=RequestMethod.GET)    public void images(HttpServletRequest request, HttpServletResponse response, String receiverId) throws IOException {        if (!StringUtils.isEmpty(receiverId)) {            PhamacyDrug phamacyDrug = phamacyService.selectByIdPhamacyDrug(Integer.parseInt(receiverId));            byte[] byteAry = phamacyDrug.getDrugPhoto().getBytes();            String data = new String(byteAry, "UTF-8");            BASE64Decoder encoder = new BASE64Decoder();            byte[] bytes = encoder.decodeBuffer(data);            for (int i = 0; i < bytes.length; i++) {                if (bytes[i] < 0) {                    bytes[i] += 256;                }            }            response.setContentType("image/jpeg");            ServletOutputStream out = response.getOutputStream();            out.write(bytes);            out.flush();            out.close();        }    }    //验证码生成    @RequestMapping("/userImage")    public void Image(HttpServletRequest request, HttpServletResponse response) {        session =request.getSession();        try {            Map<String, BufferedImage> images = com.cy.util.ImageUtil.createImage();            String keyCode = images.keySet().iterator().next();            BufferedImage image = images.get(keyCode);            session.setAttribute("code",keyCode);            ServletOutputStream out = response.getOutputStream();            ImageIO.write(image, "jpg", out);        } catch (IOException e) {            // TODO Auto-generated catch block            e.printStackTrace();        }    }    //登录    @RequestMapping("/userLogin")    public void Login(Model model, User user , HttpServletRequest request, HttpServletResponse response) throws SQLException, IOException, ServletException {        session = request.getSession();        String sessionCode = (String) session.getAttribute("code");        String code = request.getParameter("code");        if (code.equalsIgnoreCase(sessionCode)) {            User userResult = userServiceImpl.userLogin(user);            if(userResult!=null){                model.addAttribute("user", userResult);                request.getRequestDispatcher("/WEB-INF/userPage/pharacyDrugs.jsp").forward(request,response);            }else{                response.sendRedirect("userLogin.jsp");            }        }else{            request.setAttribute("codeResult", "验证码错误");            request.getRequestDispatcher("/userLogin.jsp").forward(request,response);        }    }    //账号查重    @RequestMapping("/checkUserName")    @ResponseBody    public Map checkAdminName(String userName,HttpServletResponse   response){        Map<String,Object>checkName =new HashMap<String,Object>();        User userResult = userServiceImpl.checkName(userName);        if(userResult!=null){            checkName.put("success",true);            checkName.put("message","请输入密码");            return checkName;        }else{            checkName.put("failure",false);            checkName.put("message","用户不存在");            return checkName;        }    }    //重置密码    @RequestMapping("/newPassword.action")    public String newPassword(HttpServletRequest request,User user){     int result=   userServiceImpl.setPassword(user);        return "redirect:/userLogin.jsp";    }    //    增加用户    @RequestMapping("/userAdd")    @ResponseBody    public Map  userAdd(Model model,User user,HttpServletRequest request,HttpServletResponse response) throws ServletException, IOException {        if(user.getPassword()==null){            addUserMap.put("success",false);            addUserMap.put("message","密码不能为空");            return addUserMap;        }else if(userServiceImpl.checkName(user.getUserName())!=null){            addUserMap.put("success",false);            addUserMap.put("message","用户已存在");            return addUserMap;        }        int result=userServiceImpl.userRegister(user);        if(result>0){            User userResult = userServiceImpl.userLogin(user);            if(userResult!=null){                model.addAttribute("user", userResult);                request.getRequestDispatcher("/WEB-INF/userPage/pharacyDrugs.jsp").forward(request,response);                return null;            }        }else {            addUserMap.put("success",false);            addUserMap.put("message","添加失败");            return addUserMap;        }        return null;    }}